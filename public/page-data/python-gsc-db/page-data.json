{"componentChunkName":"component---src-templates-post-js","path":"/python-gsc-db/","result":{"data":{"markdownRemark":{"id":"938f7d30-b225-59ca-aa04-b27f3151f477","excerpt":"サーチコンソールのデータをDBに保存して、検索パフォーマンスを月別に比較したりできたらいいなと思ってPythonでプログラムを書くことに。 今回作るプログラム Google Search ConsoleからAPI経由で、日付ごとの検索パフォーマンスをMySQLデータベースに保存する データベースを準備する Google…","tableOfContents":"<ul>\n<li><a href=\"/python-gsc-db/#%E3%83%87%E3%83%BC%E3%82%BF%E3%83%99%E3%83%BC%E3%82%B9%E3%82%92%E6%BA%96%E5%82%99%E3%81%99%E3%82%8B\">データベースを準備する</a></li>\n<li>\n<p><a href=\"/python-gsc-db/#google-search-console%E3%81%AE%E3%83%87%E3%83%BC%E3%82%BF%E3%82%92db%E3%81%AB%E4%BF%9D%E5%AD%98%E3%81%99%E3%82%8B%E3%83%97%E3%83%AD%E3%82%B0%E3%83%A9%E3%83%A0\">Google Search ConsoleのデータをDBに保存するプログラム</a></p>\n<ul>\n<li><a href=\"/python-gsc-db/#%E4%BA%8B%E5%89%8D%E6%BA%96%E5%82%99\">事前準備</a></li>\n<li><a href=\"/python-gsc-db/#python%E3%83%97%E3%83%AD%E3%82%B0%E3%83%A9%E3%83%A0\">Pythonプログラム</a></li>\n<li><a href=\"/python-gsc-db/#%E3%83%97%E3%83%AD%E3%82%B0%E3%83%A9%E3%83%A0%E3%81%AE%E5%AE%9F%E8%A1%8C\">プログラムの実行</a></li>\n</ul>\n</li>\n<li><a href=\"/python-gsc-db/#db%E3%81%8B%E3%82%89csv%E5%87%BA%E5%8A%9B%E3%81%99%E3%82%8B%E3%83%97%E3%83%AD%E3%82%B0%E3%83%A9%E3%83%A0\">DBからCSV出力するプログラム</a></li>\n</ul>","html":"<p>サーチコンソールのデータをDBに保存して、検索パフォーマンスを月別に比較したりできたらいいなと思ってPythonでプログラムを書くことに。</p>\n<p>今回作るプログラム Google Search ConsoleからAPI経由で、日付ごとの検索パフォーマンスをMySQLデータベースに保存する</p>\n<h2 id=\"データベースを準備する\" style=\"position:relative;\">データベースを準備する</h2>\n<p>Google Search ConsoleからAPI経由で、日付ごとに下記データを取得します。</p>\n<ul>\n<li>ページ</li>\n<li>クエリ</li>\n<li>クリック数</li>\n<li>Impression</li>\n<li>CTR</li>\n<li>掲載順位</li>\n</ul>\n<p>テーブルにはこのようにデータが保存されます\n<span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 800px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 14.500000000000002%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAADABQDASIAAhEBAxEB/8QAFgABAQEAAAAAAAAAAAAAAAAAAAEF/8QAFAEBAAAAAAAAAAAAAAAAAAAAAP/aAAwDAQACEAMQAAAB2aEB/8QAFhABAQEAAAAAAAAAAAAAAAAAAAEh/9oACAEBAAEFAkmP/8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAwEBPwE//8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAgEBPwE//8QAFRABAQAAAAAAAAAAAAAAAAAAARD/2gAIAQEABj8Cb//EABgQAAMBAQAAAAAAAAAAAAAAAAABESFB/9oACAEBAAE/IYuBVYiLcP/aAAwDAQACAAMAAAAQgA//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAEDAQE/ED//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAECAQE/ED//xAAaEAACAwEBAAAAAAAAAAAAAAABEQAhQTFR/9oACAEBAAE/EPM4chLDXocUUAXP/9k='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"データ保存例\"\n        title=\"データ保存例\"\n        src=\"/static/3d9d0e55a2b069b2593692da1823362a/4b190/ss-20200524-db.jpg\"\n        srcset=\"/static/3d9d0e55a2b069b2593692da1823362a/e07e9/ss-20200524-db.jpg 200w,\n/static/3d9d0e55a2b069b2593692da1823362a/066f9/ss-20200524-db.jpg 400w,\n/static/3d9d0e55a2b069b2593692da1823362a/4b190/ss-20200524-db.jpg 800w,\n/static/3d9d0e55a2b069b2593692da1823362a/e5166/ss-20200524-db.jpg 1200w,\n/static/3d9d0e55a2b069b2593692da1823362a/b17f8/ss-20200524-db.jpg 1600w,\n/static/3d9d0e55a2b069b2593692da1823362a/7c616/ss-20200524-db.jpg 1837w\"\n        sizes=\"(max-width: 800px) 100vw, 800px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span></p>\n<p>SQLはこちら</p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token comment\">-- DATABASE作成</span>\n<span class=\"token keyword\">CREATE</span> <span class=\"token keyword\">DATABASE</span> searchdata_db<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">USE</span> searchdata_db<span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">-- TABLE作成</span>\n<span class=\"token keyword\">CREATE</span> <span class=\"token keyword\">TABLE</span> log_daily_query <span class=\"token punctuation\">(</span>\n  ID <span class=\"token keyword\">INT</span><span class=\"token punctuation\">(</span><span class=\"token number\">11</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">NOT</span> <span class=\"token boolean\">NULL</span> AUTO INCREMENT<span class=\"token punctuation\">,</span>\n  <span class=\"token keyword\">Date</span>  <span class=\"token keyword\">DATE</span> <span class=\"token operator\">NOT</span> <span class=\"token boolean\">NULL</span><span class=\"token punctuation\">,</span>\n  Query <span class=\"token keyword\">VARCHAR</span><span class=\"token punctuation\">(</span><span class=\"token number\">100</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">NOT</span> <span class=\"token boolean\">NULL</span><span class=\"token punctuation\">,</span>\n  Page <span class=\"token keyword\">VARCHAR</span><span class=\"token punctuation\">(</span><span class=\"token number\">2000</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">NOT</span> <span class=\"token boolean\">NULL</span><span class=\"token punctuation\">,</span>\n  Clicks <span class=\"token keyword\">INT</span><span class=\"token punctuation\">(</span><span class=\"token number\">11</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">DEFAULT</span> <span class=\"token boolean\">NULL</span><span class=\"token punctuation\">,</span>\n  Impressions <span class=\"token keyword\">INT</span><span class=\"token punctuation\">(</span><span class=\"token number\">11</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">DEFAULT</span> <span class=\"token boolean\">NULL</span><span class=\"token punctuation\">,</span>\n  CTR <span class=\"token keyword\">FLOAT</span> <span class=\"token keyword\">DEFAULT</span> <span class=\"token boolean\">NULL</span><span class=\"token punctuation\">,</span>\n  Position <span class=\"token keyword\">FLOAT</span> <span class=\"token keyword\">DEFAULT</span> <span class=\"token boolean\">NULL</span><span class=\"token punctuation\">,</span>\n  <span class=\"token keyword\">Timestamp</span> <span class=\"token keyword\">DATETIME</span> <span class=\"token operator\">NOT</span> <span class=\"token boolean\">NULL</span><span class=\"token punctuation\">,</span>\n  <span class=\"token keyword\">PRIMARY</span> <span class=\"token keyword\">KEY</span> <span class=\"token punctuation\">(</span>ID<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token operator\">+</span><span class=\"token comment\">-------------+---------------+------+-----+---------+----------------+</span>\n<span class=\"token operator\">|</span> Field       <span class=\"token operator\">|</span> <span class=\"token keyword\">Type</span>          <span class=\"token operator\">|</span> <span class=\"token boolean\">Null</span> <span class=\"token operator\">|</span> <span class=\"token keyword\">Key</span> <span class=\"token operator\">|</span> <span class=\"token keyword\">Default</span> <span class=\"token operator\">|</span> Extra          <span class=\"token operator\">|</span>\n<span class=\"token operator\">+</span><span class=\"token comment\">-------------+---------------+------+-----+---------+----------------+</span>\n<span class=\"token operator\">|</span> ID          <span class=\"token operator\">|</span> <span class=\"token keyword\">int</span>           <span class=\"token operator\">|</span> <span class=\"token keyword\">NO</span>   <span class=\"token operator\">|</span> PRI <span class=\"token operator\">|</span> <span class=\"token boolean\">NULL</span>    <span class=\"token operator\">|</span> <span class=\"token keyword\">auto_increment</span> <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span> <span class=\"token keyword\">Date</span>        <span class=\"token operator\">|</span> <span class=\"token keyword\">date</span>          <span class=\"token operator\">|</span> <span class=\"token keyword\">NO</span>   <span class=\"token operator\">|</span>     <span class=\"token operator\">|</span> <span class=\"token boolean\">NULL</span>    <span class=\"token operator\">|</span>                <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span> Query       <span class=\"token operator\">|</span> <span class=\"token keyword\">varchar</span><span class=\"token punctuation\">(</span><span class=\"token number\">100</span><span class=\"token punctuation\">)</span>  <span class=\"token operator\">|</span> <span class=\"token keyword\">NO</span>   <span class=\"token operator\">|</span>     <span class=\"token operator\">|</span> <span class=\"token boolean\">NULL</span>    <span class=\"token operator\">|</span>                <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span> Page        <span class=\"token operator\">|</span> <span class=\"token keyword\">varchar</span><span class=\"token punctuation\">(</span><span class=\"token number\">2000</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">|</span> <span class=\"token keyword\">NO</span>   <span class=\"token operator\">|</span>     <span class=\"token operator\">|</span> <span class=\"token boolean\">NULL</span>    <span class=\"token operator\">|</span>                <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span> Clicks      <span class=\"token operator\">|</span> <span class=\"token keyword\">int</span>           <span class=\"token operator\">|</span> YES  <span class=\"token operator\">|</span>     <span class=\"token operator\">|</span> <span class=\"token boolean\">NULL</span>    <span class=\"token operator\">|</span>                <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span> Impressions <span class=\"token operator\">|</span> <span class=\"token keyword\">int</span>           <span class=\"token operator\">|</span> YES  <span class=\"token operator\">|</span>     <span class=\"token operator\">|</span> <span class=\"token boolean\">NULL</span>    <span class=\"token operator\">|</span>                <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span> CTR         <span class=\"token operator\">|</span> <span class=\"token keyword\">float</span>         <span class=\"token operator\">|</span> YES  <span class=\"token operator\">|</span>     <span class=\"token operator\">|</span> <span class=\"token boolean\">NULL</span>    <span class=\"token operator\">|</span>                <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span> Position    <span class=\"token operator\">|</span> <span class=\"token keyword\">float</span>         <span class=\"token operator\">|</span> YES  <span class=\"token operator\">|</span>     <span class=\"token operator\">|</span> <span class=\"token boolean\">NULL</span>    <span class=\"token operator\">|</span>                <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span> <span class=\"token keyword\">Timestamp</span>   <span class=\"token operator\">|</span> <span class=\"token keyword\">datetime</span>      <span class=\"token operator\">|</span> <span class=\"token keyword\">NO</span>   <span class=\"token operator\">|</span>     <span class=\"token operator\">|</span> <span class=\"token boolean\">NULL</span>    <span class=\"token operator\">|</span>                <span class=\"token operator\">|</span>\n<span class=\"token operator\">+</span><span class=\"token comment\">-------------+---------------+------+-----+---------+----------------+</span></code></pre></div>\n<h2 id=\"google-search-consoleのデータをdbに保存するプログラム\" style=\"position:relative;\">Google Search ConsoleのデータをDBに保存するプログラム</h2>\n<h3 id=\"事前準備\" style=\"position:relative;\">事前準備</h3>\n<p><a href=\"/python-google-search-console-api/\">Google Search Console APIデータをCSV出力するプログラム</a>を参考に、Google Search Console APIに接続しデータを取得するプログラムを用意しておきます。</p>\n<p>今回使うライブラリをインストールします。</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">pip install mysqlclient</code></pre></div>\n<p>参考記事\n<a href=\"/node-js-mysql/\">MySQLの接続の仕方</a></p>\n<h3 id=\"pythonプログラム\" style=\"position:relative;\">Pythonプログラム</h3>\n<div class=\"gatsby-code-title\">gsc_to_db.py</div>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">import</span> sys\n<span class=\"token keyword\">import</span> MySQLdb\n<span class=\"token keyword\">import</span> datetime\n\n<span class=\"token keyword\">from</span> googleapiclient<span class=\"token punctuation\">.</span>discovery <span class=\"token keyword\">import</span> build\n<span class=\"token keyword\">from</span> oauth2client<span class=\"token punctuation\">.</span>service_account <span class=\"token keyword\">import</span> ServiceAccountCredentials\n\nSCOPES <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'https://www.googleapis.com/auth/webmasters.readonly'</span><span class=\"token punctuation\">]</span>\nJSON_PATH <span class=\"token operator\">=</span> <span class=\"token string\">'./JSONファイルの名前'</span>\nTARGET_URL <span class=\"token operator\">=</span> <span class=\"token string\">'サイトのURL'</span>\nDATABASE <span class=\"token operator\">=</span> <span class=\"token string\">'searchdata_db'</span> <span class=\"token comment\"># データベース名</span>\nTABLE_NAME <span class=\"token operator\">=</span> <span class=\"token string\">'log_daily_query'</span> <span class=\"token comment\"># テーブル名</span>\n\n<span class=\"token keyword\">def</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span>argv<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n\n  connection <span class=\"token operator\">=</span> MySQLdb<span class=\"token punctuation\">.</span>connect<span class=\"token punctuation\">(</span>\n      host <span class=\"token operator\">=</span> <span class=\"token string\">'localhost'</span><span class=\"token punctuation\">,</span>\n      port <span class=\"token operator\">=</span> <span class=\"token number\">3306</span><span class=\"token punctuation\">,</span>\n      user <span class=\"token operator\">=</span> <span class=\"token string\">'root'</span><span class=\"token punctuation\">,</span>\n      password <span class=\"token operator\">=</span> <span class=\"token string\">'root'</span><span class=\"token punctuation\">,</span>\n      database <span class=\"token operator\">=</span> DATABASE<span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">)</span>\n  cursor <span class=\"token operator\">=</span> connection<span class=\"token punctuation\">.</span>cursor<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n  cursor<span class=\"token punctuation\">.</span>execute<span class=\"token punctuation\">(</span><span class=\"token string\">'select (max(date) + INTERVAL 1 DAY) as start_date from '</span> <span class=\"token operator\">+</span> TABLE_NAME<span class=\"token punctuation\">)</span>\n  start_date_arr <span class=\"token operator\">=</span> cursor<span class=\"token punctuation\">.</span>fetchone<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n  start_date <span class=\"token operator\">=</span> <span class=\"token builtin\">str</span><span class=\"token punctuation\">(</span>start_date_arr<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">if</span> start_date <span class=\"token operator\">==</span> <span class=\"token string\">'None'</span><span class=\"token punctuation\">:</span>\n    start_date <span class=\"token operator\">=</span> <span class=\"token string\">'2018-01-01'</span>\n  end_date <span class=\"token operator\">=</span> datetime<span class=\"token punctuation\">.</span>datetime<span class=\"token punctuation\">.</span>today<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>strftime<span class=\"token punctuation\">(</span><span class=\"token string\">\"%Y-%m-%d\"</span><span class=\"token punctuation\">)</span>\n\n  <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">'取得WEBサイト:'</span><span class=\"token punctuation\">,</span> TARGET_URL<span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">'取得開始日:'</span><span class=\"token punctuation\">,</span> start_date<span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">'取得終了日:'</span><span class=\"token punctuation\">,</span> end_date<span class=\"token punctuation\">)</span>\n\n  request <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token string\">'startDate'</span><span class=\"token punctuation\">:</span> start_date<span class=\"token punctuation\">,</span>\n    <span class=\"token string\">'endDate'</span><span class=\"token punctuation\">:</span> end_date<span class=\"token punctuation\">,</span>\n    <span class=\"token string\">'dimensions'</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'date'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'query'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'page'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span>\n\n  response <span class=\"token operator\">=</span> execute_request<span class=\"token punctuation\">(</span>TARGET_URL<span class=\"token punctuation\">,</span> request<span class=\"token punctuation\">)</span>\n  save_to_table<span class=\"token punctuation\">(</span>response<span class=\"token punctuation\">,</span> cursor<span class=\"token punctuation\">,</span> TABLE_NAME<span class=\"token punctuation\">)</span>\n\n  cursor<span class=\"token punctuation\">.</span>close<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  connection<span class=\"token punctuation\">.</span>commit<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  connection<span class=\"token punctuation\">.</span>close<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>cursor<span class=\"token punctuation\">.</span>rowcount<span class=\"token punctuation\">,</span> <span class=\"token string\">\"was inserted.\"</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">def</span> <span class=\"token function\">execute_request</span><span class=\"token punctuation\">(</span>property_uri<span class=\"token punctuation\">,</span> request<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n  credentials <span class=\"token operator\">=</span> ServiceAccountCredentials<span class=\"token punctuation\">.</span>from_json_keyfile_name<span class=\"token punctuation\">(</span>JSON_PATH<span class=\"token punctuation\">,</span> SCOPES<span class=\"token punctuation\">)</span>\n  webmasters <span class=\"token operator\">=</span> build<span class=\"token punctuation\">(</span><span class=\"token string\">'webmasters'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'v3'</span><span class=\"token punctuation\">,</span> credentials<span class=\"token operator\">=</span>credentials<span class=\"token punctuation\">)</span>\n\n  <span class=\"token keyword\">return</span> webmasters<span class=\"token punctuation\">.</span>searchanalytics<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>query<span class=\"token punctuation\">(</span>siteUrl<span class=\"token operator\">=</span>property_uri<span class=\"token punctuation\">,</span> body<span class=\"token operator\">=</span>request<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>execute<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">def</span> <span class=\"token function\">save_to_table</span><span class=\"token punctuation\">(</span>response<span class=\"token punctuation\">,</span>cursor<span class=\"token punctuation\">,</span> table_name<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n  <span class=\"token keyword\">if</span> <span class=\"token string\">'rows'</span> <span class=\"token keyword\">not</span> <span class=\"token keyword\">in</span> response<span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Empty response'</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">return</span>\n\n  rows <span class=\"token operator\">=</span> response<span class=\"token punctuation\">[</span><span class=\"token string\">'rows'</span><span class=\"token punctuation\">]</span>\n  insert_data <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\n  time_stamp <span class=\"token operator\">=</span> datetime<span class=\"token punctuation\">.</span>datetime<span class=\"token punctuation\">.</span>today<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>strftime<span class=\"token punctuation\">(</span><span class=\"token string\">'%Y-%m-%d %H:%M:%S'</span><span class=\"token punctuation\">)</span>\n\n  <span class=\"token keyword\">for</span> row <span class=\"token keyword\">in</span> rows<span class=\"token punctuation\">:</span>\n    insert_data<span class=\"token punctuation\">.</span>append<span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>row<span class=\"token punctuation\">[</span><span class=\"token string\">'keys'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n      row<span class=\"token punctuation\">[</span><span class=\"token string\">'keys'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n      row<span class=\"token punctuation\">[</span><span class=\"token string\">'keys'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token number\">2</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n      <span class=\"token builtin\">int</span><span class=\"token punctuation\">(</span>row<span class=\"token punctuation\">[</span><span class=\"token string\">'clicks'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n      <span class=\"token builtin\">int</span><span class=\"token punctuation\">(</span>row<span class=\"token punctuation\">[</span><span class=\"token string\">'impressions'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n      <span class=\"token builtin\">round</span><span class=\"token punctuation\">(</span>row<span class=\"token punctuation\">[</span><span class=\"token string\">'ctr'</span><span class=\"token punctuation\">]</span><span class=\"token operator\">*</span><span class=\"token number\">100</span><span class=\"token punctuation\">,</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n      <span class=\"token builtin\">round</span><span class=\"token punctuation\">(</span>row<span class=\"token punctuation\">[</span><span class=\"token string\">'position'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n      time_stamp<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n\n  cursor<span class=\"token punctuation\">.</span>executemany<span class=\"token punctuation\">(</span><span class=\"token string\">'insert into '</span> <span class=\"token operator\">+</span> table_name <span class=\"token operator\">+</span> <span class=\"token string\">' (Date, Query, Page, Clicks, Impressions, CTR, Position, Timestamp) values (%s,%s,%s,%s,%s,%s,%s,%s)'</span><span class=\"token punctuation\">,</span>insert_data<span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">if</span> __name__ <span class=\"token operator\">==</span> <span class=\"token string\">'__main__'</span><span class=\"token punctuation\">:</span>\n  main<span class=\"token punctuation\">(</span>sys<span class=\"token punctuation\">.</span>argv<span class=\"token punctuation\">)</span></code></pre></div>\n<p>このコードを<code class=\"language-text\">gsc_to_db.py</code>というファイル名で保存します。</p>\n<h3 id=\"プログラムの実行\" style=\"position:relative;\">プログラムの実行</h3>\n<p>ターミナルから、「python プログラム名」で実行します</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\">$ python 01_gsc_to_db<span class=\"token punctuation\">.</span>py\n取得WEBサイト<span class=\"token punctuation\">:</span>\n取得開始日<span class=\"token punctuation\">:</span> <span class=\"token number\">2020</span><span class=\"token operator\">-</span><span class=\"token number\">05</span><span class=\"token operator\">-</span><span class=\"token number\">17</span>\n取得終了日<span class=\"token punctuation\">:</span> <span class=\"token number\">2020</span><span class=\"token operator\">-</span><span class=\"token number\">05</span><span class=\"token operator\">-</span><span class=\"token number\">20</span>\n<span class=\"token number\">133</span> was inserted<span class=\"token punctuation\">.</span></code></pre></div>\n<h2 id=\"dbからcsv出力するプログラム\" style=\"position:relative;\">DBからCSV出力するプログラム</h2>\n<p>集計期間を指定すると、期間内の検索パフォーマンスをCSVに出力します。</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">import</span> sys\n<span class=\"token keyword\">import</span> argparse\n<span class=\"token keyword\">import</span> MySQLdb\n<span class=\"token keyword\">import</span> pandas <span class=\"token keyword\">as</span> pd\nDATABASE <span class=\"token operator\">=</span> <span class=\"token string\">'searchdata_db'</span>　<span class=\"token comment\"># データベース名</span>\n\n<span class=\"token comment\"># コマンドラインの引数</span>\n<span class=\"token comment\"># 第1引数：取得開始日</span>\n<span class=\"token comment\"># 第2引数：取得終了日</span>\nargparser <span class=\"token operator\">=</span> argparse<span class=\"token punctuation\">.</span>ArgumentParser<span class=\"token punctuation\">(</span>add_help<span class=\"token operator\">=</span><span class=\"token boolean\">False</span><span class=\"token punctuation\">)</span>\nargparser<span class=\"token punctuation\">.</span>add_argument<span class=\"token punctuation\">(</span><span class=\"token string\">'start_date'</span><span class=\"token punctuation\">,</span> <span class=\"token builtin\">type</span><span class=\"token operator\">=</span><span class=\"token builtin\">str</span><span class=\"token punctuation\">,</span>\n    <span class=\"token builtin\">help</span><span class=\"token operator\">=</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Start date of the requested date range in '</span>\n    <span class=\"token string\">'YYYY-MM-DD format.'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\nargparser<span class=\"token punctuation\">.</span>add_argument<span class=\"token punctuation\">(</span><span class=\"token string\">'end_date'</span><span class=\"token punctuation\">,</span> <span class=\"token builtin\">type</span><span class=\"token operator\">=</span><span class=\"token builtin\">str</span><span class=\"token punctuation\">,</span>\n    <span class=\"token builtin\">help</span><span class=\"token operator\">=</span><span class=\"token punctuation\">(</span><span class=\"token string\">'End date of the requested date range in '</span>\n    <span class=\"token string\">'YYYY-MM-DD format.'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\nargs <span class=\"token operator\">=</span> argparser<span class=\"token punctuation\">.</span>parse_args<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">def</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span>argv<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n\n    connection <span class=\"token operator\">=</span> MySQLdb<span class=\"token punctuation\">.</span>connect<span class=\"token punctuation\">(</span>\n        host <span class=\"token operator\">=</span> <span class=\"token string\">'localhost'</span><span class=\"token punctuation\">,</span>\n        port <span class=\"token operator\">=</span> <span class=\"token number\">3306</span><span class=\"token punctuation\">,</span>\n        user <span class=\"token operator\">=</span> <span class=\"token string\">'root'</span><span class=\"token punctuation\">,</span>\n        password <span class=\"token operator\">=</span> <span class=\"token string\">'root'</span><span class=\"token punctuation\">,</span>\n        database <span class=\"token operator\">=</span> DATABASE<span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">)</span>\n    cursor <span class=\"token operator\">=</span> connection<span class=\"token punctuation\">.</span>cursor<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n    sql <span class=\"token operator\">=</span> <span class=\"token string\">\"SELECT Page, Query, SUM(Clicks), SUM(Impressions), ROUND(AVG(CTR),2), ROUND(AVG(Position),2) FROM log_daily_query WHERE date BETWEEN '%s' AND '%s' GROUP BY Page,Query ORDER BY Page,Query, SUM(Clicks);\"</span> <span class=\"token operator\">%</span> <span class=\"token punctuation\">(</span>args<span class=\"token punctuation\">.</span>start_date<span class=\"token punctuation\">,</span>args<span class=\"token punctuation\">.</span>end_date<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>sql<span class=\"token punctuation\">)</span>\n    cursor<span class=\"token punctuation\">.</span>execute<span class=\"token punctuation\">(</span>sql<span class=\"token punctuation\">)</span>\n\n    rows <span class=\"token operator\">=</span> cursor<span class=\"token punctuation\">.</span>fetchall<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n    output_csv <span class=\"token operator\">=</span> pd<span class=\"token punctuation\">.</span>DataFrame<span class=\"token punctuation\">(</span>\n        rows<span class=\"token punctuation\">,</span>\n        columns <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'Page'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'Query'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'Click'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'Impression'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'CTR'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'Position'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n    output_csv<span class=\"token punctuation\">.</span>to_csv<span class=\"token punctuation\">(</span><span class=\"token string\">'output_'</span><span class=\"token operator\">+</span> args<span class=\"token punctuation\">.</span>start_date <span class=\"token operator\">+</span> <span class=\"token string\">'-'</span> <span class=\"token operator\">+</span> args<span class=\"token punctuation\">.</span>end_date <span class=\"token operator\">+</span> <span class=\"token string\">'.csv'</span><span class=\"token punctuation\">,</span> index<span class=\"token operator\">=</span><span class=\"token boolean\">False</span><span class=\"token punctuation\">)</span>\n\n    connection<span class=\"token punctuation\">.</span>commit<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    connection<span class=\"token punctuation\">.</span>close<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">if</span> __name__ <span class=\"token operator\">==</span> <span class=\"token string\">'__main__'</span><span class=\"token punctuation\">:</span>\n  main<span class=\"token punctuation\">(</span>sys<span class=\"token punctuation\">.</span>argv<span class=\"token punctuation\">)</span></code></pre></div>\n<p>プログラムの実行</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">$ python 02_db_to_csv.py &#39;2020-04-01&#39; &#39;2020-04-30&#39;\nSELECT Page, Query, SUM(Clicks), SUM(Impressions), ROUND(AVG(CTR),2), ROUND(AVG(Position),2) FROM log_daily_query WHERE date BETWEEN &#39;2020-04-01&#39; AND &#39;2020-04-30&#39; GROUP BY Page,Query ORDER BY Page,Query, SUM(Clicks);</code></pre></div>\n<p>出力されるCSV：\noutput_2020-04-01-2020-04-30.csv\n<span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 800px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 20%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAEABQDASIAAhEBAxEB/8QAFwABAAMAAAAAAAAAAAAAAAAAAAEEBf/EABQBAQAAAAAAAAAAAAAAAAAAAAD/2gAMAwEAAhADEAAAAdG2EA//xAAZEAABBQAAAAAAAAAAAAAAAAABAAIREiH/2gAIAQEAAQUCDjaMX//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQMBAT8BP//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQIBAT8BP//EABQQAQAAAAAAAAAAAAAAAAAAABD/2gAIAQEABj8Cf//EABkQAQACAwAAAAAAAAAAAAAAAAEAESFB8f/aAAgBAQABPyFFVazuB6hP/9oADAMBAAIAAwAAABDzz//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQMBAT8QP//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQIBAT8QP//EABoQAAMBAAMAAAAAAAAAAAAAAAERIQAxQVH/2gAIAQEAAT8QNDTAmyqGgdtIj59O/9k='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"OutputCSV\"\n        title=\"OutputCSV\"\n        src=\"/static/b0f6368284541eabef408d5b4a948be9/4b190/ss-20200524-csv.jpg\"\n        srcset=\"/static/b0f6368284541eabef408d5b4a948be9/e07e9/ss-20200524-csv.jpg 200w,\n/static/b0f6368284541eabef408d5b4a948be9/066f9/ss-20200524-csv.jpg 400w,\n/static/b0f6368284541eabef408d5b4a948be9/4b190/ss-20200524-csv.jpg 800w,\n/static/b0f6368284541eabef408d5b4a948be9/e5166/ss-20200524-csv.jpg 1200w,\n/static/b0f6368284541eabef408d5b4a948be9/b17f8/ss-20200524-csv.jpg 1600w,\n/static/b0f6368284541eabef408d5b4a948be9/03680/ss-20200524-csv.jpg 1652w\"\n        sizes=\"(max-width: 800px) 100vw, 800px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span></p>","frontmatter":{"title":"【Python】Google Search Consoleの検索パフォーマンスをDBに保存するプログラム","date":"2020/05/24","updateDate":null,"description":null,"category":"Programming","tags":["Python"],"featured":{"childImageSharp":{"fluid":{"base64":"data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAALABQDASIAAhEBAxEB/8QAFwABAQEBAAAAAAAAAAAAAAAAAAEDBf/EABUBAQEAAAAAAAAAAAAAAAAAAAAB/9oADAMBAAIQAxAAAAHr6WSgf//EABYQAQEBAAAAAAAAAAAAAAAAAAERIP/aAAgBAQABBQJW5//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQMBAT8BP//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQIBAT8BP//EABQQAQAAAAAAAAAAAAAAAAAAACD/2gAIAQEABj8CX//EABkQAAEFAAAAAAAAAAAAAAAAAAEAESAxcf/aAAgBAQABPyEVorEY/wD/2gAMAwEAAgADAAAAEBDP/8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAwEBPxA//8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAgEBPxA//8QAGhABAAMAAwAAAAAAAAAAAAAAAQARUSBBYf/aAAgBAQABPxB1i1FXYewbN4f/2Q==","aspectRatio":1.7699115044247788,"src":"/static/a045fe622dc05e4681e2de9b3a7eb575/14b42/icatch-20200524.jpg","srcSet":"/static/a045fe622dc05e4681e2de9b3a7eb575/f836f/icatch-20200524.jpg 200w,\n/static/a045fe622dc05e4681e2de9b3a7eb575/2244e/icatch-20200524.jpg 400w,\n/static/a045fe622dc05e4681e2de9b3a7eb575/14b42/icatch-20200524.jpg 800w,\n/static/a045fe622dc05e4681e2de9b3a7eb575/a6352/icatch-20200524.jpg 960w","sizes":"(max-width: 800px) 100vw, 800px"},"original":{"height":540,"src":"/static/icatch-20200524-a045fe622dc05e4681e2de9b3a7eb575.jpg","width":960}}}}}},"pageContext":{"slug":"/python-gsc-db/","prev":{"fields":{"slug":"/python-google-search-console-api/"},"frontmatter":{"title":"【Python】Google Search Console APIから検索パフォーマンスをCSV出力するプログラム"}},"next":{"fields":{"slug":"/python-livedoor-replace-program/"},"frontmatter":{"title":"【Python】Livedoorのバックアップデータ（backup.txt）をWordPress移行用に置き換える"}}}},"staticQueryHashes":["1941199855","3628787746","4032985131"]}